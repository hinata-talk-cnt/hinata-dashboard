<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å‘å‚46 Message Dashboard</title>
    
    <meta property="og:title" content="æ—¥å‘å‚46 Message Dashboard">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* =========================================
           1. CSSå¤‰æ•°å®šç¾© & åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
           ========================================= */
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #555555; 
            --accent-color: #4b89dc;
            --accent-pink: #e91e63;
            --accent-orange: #ff9800;
            --accent-green: #4caf50;
            --accent-gold: #f1c40f;
            --border-color: #eeeeee;
            --hover-bg: #f0f8ff;
            --twitter-blue: #1da1f2;
        }

        html { scroll-behavior: smooth; }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 20px;
            color: var(--text-main);
            -webkit-text-size-adjust: 100%;
        }
        body.no-scroll { overflow: hidden; }

        .container {
            max-width: 1200px; margin: 0 auto;
            display: flex; gap: 20px; align-items: flex-start;
        }

        .sidebar { 
            width: 280px; flex-shrink: 0; 
            display: flex; flex-direction: column; gap: 20px; 
            position: sticky; top: 20px;
            max-height: 95vh; overflow-y: auto;
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è£…é£¾ */
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }

        .main-content { flex-grow: 1; min-width: 0; }

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; position: static; max-height: none; }
            .stats-row { grid-template-columns: repeat(2, 1fr) !important; }
            .archive-list { max-height: 150px; overflow-y: auto; border-bottom: 1px solid #eee; }
        }

        /* ã‚«ãƒ¼ãƒ‰å…±é€š */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
            flex-shrink: 0;
        }

        .card-header {
            padding: 12px 15px;
            background: #fff;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            color: #444; 
            display: flex; justify-content: space-between; align-items: center;
            font-size: 14px;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-widget { padding: 15px; }
        .cal-header { display: flex; align-items: center; margin-bottom: 10px; gap: 5px; }
        .cal-title { font-size: 14px; font-weight: bold; margin: 0 10px; flex-grow: 1; text-align: center; }
        .cal-nav { cursor: pointer; border: none; background: #f0f0f0; border-radius: 4px; padding: 4px 8px; font-size: 12px; transition: 0.2s; }
        .cal-nav:hover:not(:disabled) { background: #e0e0e0; }
        .cal-nav:disabled { opacity: 0.3; cursor: not-allowed; }
        .cal-latest { margin-left: auto; background: var(--accent-pink); color: white; font-weight: bold; }
        .cal-latest:hover { background: #c2185b; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-head { font-size: 10px; color: #999; margin-bottom: 4px; }
        .cal-day { aspect-ratio: 1; border-radius: 6px; font-size: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #f9f9f9; color: #ccc; transition: 0.1s; }
        .cal-day:hover:not(.disabled) { transform: scale(1.1); z-index: 2; border: 1px solid #666; }
        .cal-day.active { border: 2px solid #333; background: #fff !important; color: #333 !important; font-weight: bold; }
        .cal-day.empty { background: transparent !important; cursor: default; pointer-events: none; }
        .cal-day.disabled { opacity: 0.3; cursor: default; pointer-events: none; background: #eee; color: #ccc; }
        .lvl-1 { background: #e3f2fd; color: #1565c0; } 
        .lvl-2 { background: #90caf9; color: #0d47a1; } 
        .lvl-3 { background: #42a5f5; color: #fff; } 
        .lvl-4 { background: #1565c0; color: #fff; }

        /* ãƒªã‚¹ãƒˆ */
        .archive-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; }
        .archive-item { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .archive-item:hover { background: #f9f9f9; color: var(--accent-color); }
        .archive-item.active { background: #eaf6fd; color: var(--accent-color); font-weight: bold; border-left: 4px solid var(--accent-color); }
        .archive-count { background: #e0e0e0; padding: 3px 10px; border-radius: 12px; font-size: 12px; color: #222; font-weight: 800; }

        /* çµ±è¨ˆã‚¨ãƒªã‚¢ */
        .main-nav { display: flex; gap: 15px; margin-bottom: 20px; }
        .nav-btn { flex: 1; padding: 15px; border: none; background: white; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; color: #666; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .nav-btn.active { background: var(--accent-color); color: white; box-shadow: 0 4px 10px rgba(75, 137, 220, 0.3); }
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .stat-box::after { content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: #eee; }
        .stat-box.blue::after { background: var(--accent-color); } .stat-box.pink::after { background: var(--accent-pink); }
        .stat-box.orange::after { background: var(--accent-orange); } .stat-box.green::after { background: var(--accent-green); }
        .stat-label { font-size: 12px; color: #555; display: block; margin-bottom: 8px; font-weight: 800; letter-spacing: 0.5px; }
        .stat-val { height: 50px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: bold; color: #222; line-height: 1.1; overflow: hidden; word-break: break-all; }
        .stat-val.multi { font-size: 15px; line-height: 1.3; white-space: normal; }
        .stat-sub { font-size: 14px; color: #333; margin-top: 5px; font-weight: 800; }

        /* ãƒ“ãƒ¥ãƒ¼åˆ¶å¾¡ */
        .controls-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .view-title { font-size: 18px; font-weight: bold; color: #333; display: flex; align-items: center; gap: 10px; }
        .view-badge { background: #666; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .title-nav-btn { background: none; border: none; cursor: pointer; font-size: 18px; color: #999; padding: 0 5px; transition: 0.2s; }
        .title-nav-btn:hover:not(:disabled) { color: var(--accent-color); transform: scale(1.2); }
        .title-nav-btn:disabled { color: #ddd; cursor: not-allowed; transform: none; opacity: 0.5; }
        select { padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; background: #f9f9f9; cursor: pointer; }
        
        .ranking-table { width: 100%; border-collapse: collapse; }
        .ranking-table td { padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 14px; vertical-align: middle; }
        .ranking-table tr:hover { background: var(--hover-bg); }
        .rank-num { display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; background: #eee; font-size: 12px; font-weight: bold; color: #555; }
        .rank-1 { background: #ffd700; color: white; } .rank-2 { background: #c0c0c0; color: white; } .rank-3 { background: #c47022; color: white; }
        .bar-wrap { display: flex; align-items: center; gap: 10px; width: 100%; }
        .bar-bg { flex-grow: 1; background: #f0f0f0; height: 10px; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 5px; transition: width 0.5s; }
        .bar-txt { font-weight: bold; font-size: 13px; width: 45px; text-align: right; }

        /* ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚°ãƒªãƒƒãƒ‰ */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 10px; }
        .m-card { background: white; border: 1px solid #eee; border-radius: 10px; padding: 12px 5px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; border-top: 3px solid var(--c); }
        .m-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--accent-color); }
        .m-icon { width: 40px; height: 40px; background: #f5f5f5; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #ccc; border: 2px solid var(--c); font-size: 16px; }
        .m-name { font-weight: bold; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .x-link { text-decoration: none; color: var(--twitter-blue); font-size: 12px; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: #f0f8ff; }
        .x-link:hover { background: var(--twitter-blue); color: white; }
        .gen-section { margin-bottom: 25px; }
        .gen-header { font-size: 15px; font-weight: bold; color: var(--accent-color); border-bottom: 2px solid #f0f0f0; padding: 0 15px 5px; margin-bottom: 5px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(2px); }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; width: 95%; max-width: 950px; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1000; max-height: 95vh; overflow-y: auto; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .close-btn { border: none; background: none; font-size: 28px; cursor: pointer; color: #999; }
        .modal-nav-row { display: grid; grid-template-columns: 50px 1fr 50px; gap: 0; align-items: center; width: 100%; }
        .modal-title-col { text-align: center; overflow: hidden; }
        .nav-arrow { border: none; background: #f5f5f5; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-weight: bold; color: #555; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 18px; margin: 0 auto; }
        .nav-arrow:hover { background: #e0e0e0; color: #333; }
        .chart-box { height: 420px; margin-top: 20px; position: relative; }
        #dailyModal { z-index: 1001; width: 90%; max-width: 600px; }
        .daily-list-wrap { max-height: 60vh; overflow-y: auto; padding-right: 5px; }
        
        .app-view { display: none; } .app-view.active { display: block; }
        .hidden { display: none !important; }
        #recordContentArea { padding: 0; }
        #loadingMask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #666; transition: opacity 0.5s; }
    </style>
</head>
<body>

<div id="loadingMask">Loading data...</div>

<div class="container">
    <div class="sidebar">
        <div class="card">
            <div class="card-header">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼<span id="calCurrentMonthLabel" style="font-size:12px; color:#888;"></span></div>
            <div class="calendar-widget">
                <div class="cal-header">
                    <button class="cal-nav" id="btnPrevMonth">â—€</button>
                    <span class="cal-title" id="calTitle">-</span>
                    <button class="cal-nav" id="btnNextMonth">â–¶</button>
                    <button class="cal-nav cal-latest" id="btnLatest">æœ€æ–°</button>
                </div>
                <div class="cal-grid"><div class="cal-head">æœˆ</div><div class="cal-head">ç«</div><div class="cal-head">æ°´</div><div class="cal-head">æœ¨</div><div class="cal-head">é‡‘</div><div class="cal-head">åœŸ</div><div class="cal-head">æ—¥</div></div>
                <div id="miniCalendar" class="cal-grid"></div>
            </div>
        </div>
        <div class="card"><div class="card-header">ğŸ“‚ æœˆåˆ¥</div><ul class="archive-list" id="archiveList"></ul></div>
        <div class="card"><div class="card-header">ğŸ† æœŸé–“</div><ul class="archive-list" id="periodList"></ul></div>
        
        <div class="card">
            <div class="card-header">â„¹ï¸ Information</div>
            <div style="padding:15px; font-size:13px; line-height:1.6; color:#444;">
                <p style="margin-bottom:15px;">
                    <span style="color:#e91e63; font-weight:bold;">â€»ã”æ³¨æ„</span><br>
                    å½“ã‚µã‚¤ãƒˆã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã¯<br>
                    <b>2023å¹´11æœˆä»¥é™</b><br>
                    ã®çµæœã®ã¿åæ˜ ã•ã‚Œã¦ã„ã¾ã™ã€‚
                </p>
                <p style="margin-bottom:15px; color:#888; font-size:11px;">
                    â€»PCç’°å¢ƒã§ã®é–²è¦§ã‚’æ¨å¥¨ã—ã¾ã™
                </p>
                <div style="text-align:center; border-top:1px solid #eee; padding-top:10px;">
                    <span style="font-size:11px; color:#666; font-weight:bold;">Developer</span><br>
                    <a href="https://x.com/hinata_talk_cnt" target="_blank" style="text-decoration:none; color:var(--twitter-blue); font-weight:bold; font-size:14px; display:inline-flex; align-items:center; gap:4px;">
                        <span>ğ•</span> @hinata_talk_cnt
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContentScroll">
        <div class="main-nav">
            <button id="navAnalytics" class="nav-btn active">ğŸ“Š ãƒ‡ãƒ¼ã‚¿</button>
            <button id="navMembers" class="nav-btn">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</button>
            <button id="navRecords" class="nav-btn">ğŸ† è¨˜éŒ²</button>
        </div>
        
        <div class="stats-row" id="topStatsRow">
            <div class="stat-box blue"><span class="stat-label">TOTAL</span><span class="stat-val" id="valStat1">-</span><div class="stat-sub">æœŸé–“åˆè¨ˆ</div></div>
            <div class="stat-box pink"><span class="stat-label">TOP MEMBER</span><span class="stat-val" id="valStat2">-</span><div class="stat-sub" id="subStat2">æœ€å¤šé€ä¿¡</div></div>
            <div class="stat-box orange"><span class="stat-label">DAYS COUNT</span><span class="stat-val" id="valStat3">-</span><div class="stat-sub">é›†è¨ˆæ—¥æ•°</div></div>
            <div class="stat-box green"><span class="stat-label">AVG / DAY</span><span class="stat-val" id="valStat4">-</span><div class="stat-sub">1æ—¥å¹³å‡</div></div>
        </div>

        <div class="card">
            <div id="viewAnalytics" class="app-view active">
                <div class="controls-bar">
                    <div class="view-title">
                        <button class="title-nav-btn" id="btnPrevPeriod">â—€</button>
                        <span id="pageTitle">èª­ã¿è¾¼ã¿ä¸­...</span>
                        <button class="title-nav-btn" id="btnNextPeriod">â–¶</button>
                        <span id="pageBadge" class="view-badge">Monthly</span>
                    </div>
                    <select id="genSelector"></select>
                </div>
                <div id="rankingArea"></div>
            </div>
            
            <div id="viewMembers" class="app-view">
                <div class="controls-bar"><div class="view-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</div><select id="genSelector2"><option value="all">å…¨ãƒ¡ãƒ³ãƒãƒ¼</option><option value="1">ä¸€æœŸç”Ÿ</option><option value="2">äºŒæœŸç”Ÿ</option><option value="3">ä¸‰æœŸç”Ÿ</option><option value="4">å››æœŸç”Ÿ</option><option value="5">äº”æœŸç”Ÿ</option></select></div>
                <div id="memberGrid"></div>
            </div>

            <div id="viewRecords" class="app-view">
                <div class="controls-bar">
                    <div class="view-title">ğŸ† è¨˜éŒ²</div>
                    <select id="recordTypeSelector">
                        <option value="wins">1ä½ç²å¾—å›æ•° (Daily)</option>
                        <option value="daily_max">æ­´ä»£æœ€å¤šé€ä¿¡æ•° (1æ—¥)</option>
                        <option value="monthly_max">æœˆé–“æœ€å¤šé€ä¿¡æ•° (1ãƒ¶æœˆ)</option>
                        <option value="total">ğŸ‘‘ é€šç®—é€ä¿¡æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
                        <option value="streak">ğŸ”¥ é€£æ—¥é€ä¿¡è¨˜éŒ² (Max Streak)</option>
                        <option value="average">ğŸ“Š 1æ—¥å¹³å‡é€ä¿¡æ•° (Average)</option>
                        <option value="active_rate">ğŸ“… ç¨¼åƒç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚° (Active %)</option>
                        <option value="high_volume">ğŸ’Œ 2æ¡é€ä¿¡å›æ•° (10é€šä»¥ä¸Šã®æ—¥)</option>
                        <option value="perfect_months">ğŸ“… çš†å‹¤è³æœˆæ•° (Perfect Months)</option>
                        <option value="top3">ğŸ¥‰ è¡¨å½°å°ç²å¾—å›æ•° (Top 3)</option>
                    </select>
                </div>
                <div id="recordContentArea"></div>
            </div>
        </div>
    </div>
</div>

<div id="modalOverlay" class="modal-overlay"></div>

<div id="modal" class="modal">
    <div class="modal-head">
        <div class="modal-nav-row">
            <button class="nav-arrow" id="btnModalPrev">â—€</button>
            <div class="modal-title-col">
                <h2 id="modalName" style="margin:0;">-</h2>
                <div id="modalSubtitle" style="font-size:11px; color:#888;"></div>
            </div>
            <button class="nav-arrow" id="btnModalNext">â–¶</button>
        </div>
        <div style="display:flex; align-items:center; gap:10px; justify-content:flex-end; margin-top:10px;">
            <select id="modalPeriodSelector" style="min-width:200px;"></select>
            <button class="close-btn" onclick="closeModal()">Ã—</button>
        </div>
    </div>
    <div class="stats-row" style="margin-bottom:0; grid-template-columns: repeat(3, 1fr);">
        <div class="stat-box" style="padding:10px; box-shadow:none; background:#f9f9f9;"><span class="stat-label">æœŸé–“åˆè¨ˆ</span><span class="stat-val" id="mTotal" style="font-size:20px;">-</span></div>
        <div class="stat-box" style="padding:10px; box-shadow:none; background:#f9f9f9;"><span class="stat-label">æœŸé–“å†…æœ€é«˜</span><span class="stat-val" id="mMax" style="font-size:20px;">-</span></div>
        <div class="stat-box" style="padding:10px; box-shadow:none; background:#f9f9f9;"><span class="stat-label">å¹³å‡</span><span class="stat-val" id="mAvg" style="font-size:20px;">-</span></div>
    </div>
    <div class="chart-box"><canvas id="personalChart"></canvas></div>
</div>

<div id="dailyModal" class="modal">
    <div class="modal-head">
        <div class="modal-title-col">
            <h2 id="dailyModalTitle" style="margin:0; font-size:18px;"></h2>
        </div>
        <button class="close-btn" onclick="closeModal()">Ã—</button>
    </div>
    <div id="dailyRankingArea" class="daily-list-wrap"></div>
</div>

<script>
    const DATA_VER = new Date().getTime(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿

    let allLogs = []; 
    let allMembers = []; 
    let memberMap = {}; 
    let chartInstance = null;
    let currentFilter = { type: 'month', value: '' };
    let currentAppMode = 'analytics'; 
    let calYear = 0, calMonth = 0; 
    let currentModalMember = "";
    
    let rankingList = [];
    let catalogList = [];
    let minDateObj = null, maxDateObj = null;
    let latestValidDateStr = "";

    const genKanji = { '1': 'ä¸€æœŸç”Ÿ', '2': 'äºŒæœŸç”Ÿ', '3': 'ä¸‰æœŸç”Ÿ', '4': 'å››æœŸç”Ÿ', '5': 'äº”æœŸç”Ÿ' };

    window.onload = () => {
        Promise.all([
            fetch('data.json?v=' + DATA_VER).then(res => res.json()), 
            fetch('members.json?v=' + DATA_VER).then(res => res.json())
        ]).then(([logs, members]) => {
            allLogs = logs; 
            allMembers = members; 
            
            // â˜…å®‰å…¨å¯¾ç­–: ãƒ¡ãƒ³ãƒãƒ¼ãƒãƒƒãƒ—ä½œæˆ & ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²é©ç”¨
            allMembers.forEach(m => {
                if(!m.color || m.color === "") m.color = "#4b89dc"; // é’è‰²
                memberMap[m.name] = m;
            });
            
            processDataRange();
            initApp();
            
            // åˆå›è¡¨ç¤º
            renderRecordPage(); 
            bindEvents();
            
            // ãƒ­ãƒ¼ãƒ‰å®Œäº†
            document.getElementById('loadingMask').style.opacity = '0';
            setTimeout(() => { document.getElementById('loadingMask').style.display = 'none'; }, 500);

        }).catch(e => {
            alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:\n" + e);
            document.getElementById('loadingMask').style.display = 'none';
        });
    };

    function processDataRange() {
        let maxTs = 0;
        allLogs.forEach(l => { 
            const c = parseInt(l.count) || 0;
            if(l.date && c > 0) { 
                const d = new Date(l.date);
                d.setHours(0,0,0,0);
                
                if(!minDateObj || d < minDateObj) minDateObj = d;
                if(!maxDateObj || d > maxDateObj) maxDateObj = d;
                
                const t = d.getTime();
                if(t > maxTs) { 
                    maxTs = t; 
                    latestValidDateStr = l.date; // â˜…ã“ã“ã§ç¢ºå®Ÿã«ä»£å…¥
                }
            } 
        });
        
        // ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã‚‰ä»Šæ—¥ã‚’å…¥ã‚Œã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
        if(!latestValidDateStr) {
            const now = new Date();
            latestValidDateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
            if(!minDateObj) minDateObj = now;
            if(!maxDateObj) maxDateObj = now;
        }
    }

    function bindEvents() {
        document.getElementById('navAnalytics').onclick = () => setAppMode('analytics');
        document.getElementById('navMembers').onclick = () => setAppMode('members');
        document.getElementById('navRecords').onclick = () => setAppMode('records'); 
        
        document.getElementById('btnPrevMonth').onclick = () => shiftCal(-1);
        document.getElementById('btnNextMonth').onclick = () => shiftCal(1);
        document.getElementById('btnLatest').onclick = jumpToLatest;
        
        document.getElementById('btnPrevPeriod').onclick = () => shiftPeriod(-1);
        document.getElementById('btnNextPeriod').onclick = () => shiftPeriod(1);

        document.getElementById('btnModalPrev').onclick = () => switchModalMember(-1);
        document.getElementById('btnModalNext').onclick = () => switchModalMember(1);
        document.getElementById('modalOverlay').onclick = closeModal;
        document.getElementById('modalPeriodSelector').onchange = updateModalContent;

        document.getElementById('genSelector').onchange = renderRankingView;
        document.getElementById('genSelector2').onchange = renderMemberCatalog;
        document.getElementById('recordTypeSelector').onchange = renderRecordPage;

        const calContainer = document.getElementById('miniCalendar');
        calContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.cal-day');
            if (!target || target.classList.contains('empty') || target.classList.contains('disabled')) return;
            const dateStr = target.dataset.date;
            if (dateStr) selectPeriod('day', dateStr);
        });
    }

    function shiftPeriod(offset) {
        if (currentFilter.type === 'all') return;
        let targetType = currentFilter.type;
        let targetValue = currentFilter.value;

        if (targetType === 'month') {
            let [y, m] = targetValue.split('/').map(Number);
            m += offset;
            if (m > 12) { m = 1; y++; }
            if (m < 1) { m = 12; y--; }
            const nextMonthStart = new Date(y, m - 1, 1);
            const nextMonthEnd = new Date(y, m, 0);
            if (nextMonthEnd < minDateObj || nextMonthStart > maxDateObj) return;
            selectPeriod('month', `${y}/${m}`);
        } else if (targetType === 'day') {
            const d = new Date(targetValue);
            d.setDate(d.getDate() + offset);
            if (d < minDateObj || d > maxDateObj) return;
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const day = d.getDate();
            selectPeriod('day', `${y}/${m}/${day}`);
        } else if (targetType === 'year') {
             let y = parseInt(targetValue);
             y += offset;
             if (y < minDateObj.getFullYear() || y > maxDateObj.getFullYear()) return;
             selectPeriod('year', y.toString());
        }
    }

    function switchModalMember(offset) {
        const targetList = currentAppMode === 'analytics' ? rankingList : catalogList;
        if (!targetList || targetList.length === 0) return;
        let currentIndex = targetList.indexOf(currentModalMember);
        if (currentIndex === -1) return;
        let newIndex = currentIndex + offset;
        if (newIndex < 0) newIndex = targetList.length - 1;
        if (newIndex >= targetList.length) newIndex = 0;
        const currentVal = document.getElementById('modalPeriodSelector').value;
        openModal(targetList[newIndex], currentVal);
    }

    function jumpToLatest() {
        if (latestValidDateStr) selectPeriod('day', latestValidDateStr);
        else alert("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    }

    function initApp() {
        const months = new Set(), years = new Set();
        let grandTotal = 0;
        allLogs.forEach(l => { 
            const c = parseInt(l.count) || 0;
            if(l.date && c > 0) { 
                const p = l.date.split('/'); 
                months.add(p[0]+'/'+p[1]); 
                years.add(p[0]); 
                grandTotal += c;
            } 
        });
        const sortedMonths = Array.from(months).sort((a,b) => new Date(b+'/1') - new Date(a+'/1'));
        const sortedYears = Array.from(years).sort().reverse();

        const archiveList = document.getElementById('archiveList');
        sortedMonths.forEach(ym => {
            let count = 0; 
            const [y, m] = ym.split('/').map(Number);
            allLogs.forEach(l => { 
                const p = l.date.split('/').map(Number);
                const c = parseInt(l.count) || 0;
                if(p[0] === y && p[1] === m) count += c; 
            });
            const li = document.createElement('li'); li.className = 'archive-item';
            li.innerHTML = `<span>${ym.replace('/','å¹´')}æœˆ</span><span class="archive-count">${count.toLocaleString()}ä»¶</span>`;
            li.onclick = () => selectPeriod('month', ym);
            archiveList.appendChild(li);
        });

        const periodList = document.getElementById('periodList');
        const allLi = document.createElement('li'); allLi.className = 'archive-item';
        allLi.innerHTML = `<span>å…¨æœŸé–“</span><span class="archive-count">${grandTotal.toLocaleString()}ä»¶</span>`;
        allLi.onclick = () => selectPeriod('all', 'all');
        periodList.appendChild(allLi);

        sortedYears.forEach(y => {
            const getCounts = (year) => {
                let tY=0, tH1=0, tH2=0;
                allLogs.forEach(l => { 
                    const p=l.date.split('/').map(Number); 
                    const c=parseInt(l.count)||0;
                    if(p[0] === Number(year)){ 
                        tY+=c; if(p[1]<=6) tH1+=c; else tH2+=c; 
                    } 
                });
                return { tY, tH1, tH2 };
            };
            const c = getCounts(y);
            const addItem = (type, label, count) => {
                const li = document.createElement('li'); li.className = 'archive-item';
                li.innerHTML = `<span>${y}å¹´ ${label}</span><span class="archive-count">${count.toLocaleString()}ä»¶</span>`;
                li.onclick = () => selectPeriod(type, y.toString()); periodList.appendChild(li);
            };
            addItem('year', 'å¹´é–“', c.tY); if(c.tH1>0) addItem('h1', 'ä¸ŠåŠæœŸ', c.tH1); if(c.tH2>0) addItem('h2', 'ä¸‹åŠæœŸ', c.tH2);
        });

        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ
        const genSel = document.getElementById('genSelector');
        genSel.innerHTML = "";
        genSel.appendChild(new Option("å…¨ãƒ¡ãƒ³ãƒãƒ¼", "all"));
        ['1','2','3','4','5'].forEach(g => {
            genSel.appendChild(new Option(genKanji[g], g));
        });

        if (latestValidDateStr) {
            selectPeriod('day', latestValidDateStr);
        } else if(sortedMonths.length > 0) {
            selectPeriod('month', sortedMonths[0]);
        }
        
        renderMemberCatalog();
    }

    function selectPeriod(type, value) {
        currentFilter = { type, value };
        if(type === 'day' || type === 'month') { 
            const p = value.split('/').map(Number); 
            calYear = p[0]; 
            calMonth = p[1] - 1; 
        }
        setAppMode('analytics');
        requestAnimationFrame(() => {
            updateDashboard();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    function setAppMode(m) {
        currentAppMode = m; 
        document.getElementById('navAnalytics').classList.toggle('active', m==='analytics');
        document.getElementById('navMembers').classList.toggle('active', m==='members');
        document.getElementById('navRecords').classList.toggle('active', m==='records'); 
        
        const statsRow = document.getElementById('topStatsRow');
        if (m === 'analytics') {
            statsRow.style.display = 'grid';
        } else {
            statsRow.style.display = 'none';
        }
        
        document.getElementById('viewAnalytics').classList.toggle('active', m==='analytics');
        document.getElementById('viewMembers').classList.toggle('active', m==='members');
        document.getElementById('viewRecords').classList.toggle('active', m==='records'); 
    }

    function isDateInPeriod(dateStr, filter) {
        if(!dateStr) return false;
        if(filter.type === 'all') return true;
        const p = dateStr.split('/').map(Number);
        if(filter.type === 'day') {
            const fP = filter.value.split('/').map(Number);
            return p[0]===fP[0] && p[1]===fP[1] && p[2]===fP[2];
        }
        if(filter.type === 'month') {
            const fP = filter.value.split('/').map(Number);
            return p[0]===fP[0] && p[1]===fP[1];
        }
        if(filter.type === 'year') return p[0] === Number(filter.value);
        if(filter.type === 'h1') return p[0] === Number(filter.value) && p[1] <= 6;
        if(filter.type === 'h2') return p[0] === Number(filter.value) && p[1] >= 7;
        return false;
    }

    function updatePeriodNavButtons() {
        const btnPrev = document.getElementById('btnPrevPeriod');
        const btnNext = document.getElementById('btnNextPeriod');
        btnPrev.disabled = false;
        btnNext.disabled = false;

        if (currentFilter.type === 'month') {
            const [y, m] = currentFilter.value.split('/').map(Number);
            const prevMonthEnd = new Date(y, m - 1, 0); 
            if (prevMonthEnd < minDateObj) btnPrev.disabled = true;
            const nextMonthStart = new Date(y, m, 1);
            if (nextMonthStart > maxDateObj) btnNext.disabled = true;
        } else if (currentFilter.type === 'day') {
            const d = new Date(currentFilter.value);
            const prevD = new Date(d); prevD.setDate(d.getDate() - 1);
            const nextD = new Date(d); nextD.setDate(d.getDate() + 1);
            if (prevD < minDateObj) btnPrev.disabled = true;
            if (nextD > maxDateObj) btnNext.disabled = true;
        } else if (currentFilter.type === 'year') {
             const y = parseInt(currentFilter.value);
             if (y - 1 < minDateObj.getFullYear()) btnPrev.disabled = true;
             if (y + 1 > maxDateObj.getFullYear()) btnNext.disabled = true;
        }
    }

    function updateDashboard() {
        let total = 0, daysSet = new Set(), memTotal = {};
        allLogs.forEach(l => { 
            if(isDateInPeriod(l.date, currentFilter)) { 
                const c = parseInt(l.count) || 0; 
                total += c; 
                if(c > 0) daysSet.add(l.date); 
                if(!memTotal[l.name]) memTotal[l.name] = 0; 
                memTotal[l.name] += c; 
            } 
        });

        let maxCount = 0;
        let topMembers = [];
        for(let m in memTotal) { if(memTotal[m] > maxCount) maxCount = memTotal[m]; }
        if (maxCount > 0) {
            for(let m in memTotal) { if(memTotal[m] === maxCount) topMembers.push(m); }
        }
        
        const topMemEl = document.getElementById('valStat2');
        let topMemStr = "-";
        
        if (topMembers.length > 0) {
            if (topMembers.length === 1) {
                topMemStr = topMembers[0];
                topMemEl.classList.remove('multi');
            } else {
                topMemStr = topMembers.join(" "); 
                topMemEl.classList.add('multi');
            }
        } else {
            topMemEl.classList.remove('multi');
        }

        document.getElementById('pageTitle').innerText = (currentFilter.type === 'all' ? "å…¨æœŸé–“" : currentFilter.value);
        document.getElementById('pageBadge').innerText = (currentFilter.type === 'day' ? "Daily" : currentFilter.type === 'month' ? "Monthly" : "Long Term");
        
        document.getElementById('valStat1').innerText = total.toLocaleString();
        document.getElementById('valStat3').innerText = daysSet.size + "æ—¥";
        document.getElementById('valStat4').innerText = daysSet.size ? (total / daysSet.size).toFixed(1) : 0.0;
        
        topMemEl.innerText = topMemStr;
        topMemEl.setAttribute('title', topMemStr); 

        document.getElementById('subStat2').innerText = maxCount.toLocaleString() + "ä»¶";

        updatePeriodNavButtons();
        renderCalendarWidget(); renderRankingView();
    }

    function isActiveMemberInPeriod(member) {
        if (!member.gradDate) return true;
        const gradDate = new Date(member.gradDate);
        gradDate.setHours(23, 59, 59, 999);
        let periodStart;
        if (currentFilter.type === 'day') {
            periodStart = new Date(currentFilter.value);
        } else if (currentFilter.type === 'month') {
            const [y, m] = currentFilter.value.split('/').map(Number);
            periodStart = new Date(y, m - 1, 1);
        } else if (currentFilter.type === 'year') {
            periodStart = new Date(currentFilter.value, 0, 1);
        } else if (currentFilter.type === 'h1') {
            periodStart = new Date(currentFilter.value, 0, 1);
        } else if (currentFilter.type === 'h2') {
            periodStart = new Date(currentFilter.value, 6, 1);
        } else {
            return true;
        }
        return periodStart <= gradDate;
    }

    function renderCalendarWidget() {
        const grid = document.getElementById('miniCalendar'); grid.innerHTML = "";
        document.getElementById('calTitle').innerText = `${calYear}å¹´ ${calMonth+1}æœˆ`;
        const btnPrev = document.getElementById('btnPrevMonth');
        const btnNext = document.getElementById('btnNextMonth');
        const prevMonthEnd = new Date(calYear, calMonth, 0);
        btnPrev.disabled = (prevMonthEnd < minDateObj);
        const nextMonthStart = new Date(calYear, calMonth + 1, 1);
        btnNext.disabled = (nextMonthStart > maxDateObj);

        const first = new Date(calYear, calMonth, 1), last = new Date(calYear, calMonth + 1, 0);
        let startDay = (first.getDay() + 6) % 7; const daysCount = last.getDate();
        const daily = {}; let maxInMonth = 0;
        allLogs.forEach(l => { 
            const p = l.date.split('/').map(Number);
            if(p[0] === calYear && p[1] === (calMonth+1)) { daily[p[2]] = (daily[p[2]]||0) + (parseInt(l.count)||0); }
        });
        for(let d in daily) maxInMonth = Math.max(maxInMonth, daily[d]);
        for(let i=0; i<startDay; i++) grid.innerHTML += `<div class="cal-day empty"></div>`;
        for(let d=1; d<=daysCount; d++) {
            const dateStr = `${calYear}/${calMonth+1}/${d}`;
            const targetDate = new Date(calYear, calMonth, d);
            const c = daily[d] || 0; 
            let lvl = ""; 
            if(c > 0) lvl = "lvl-1"; 
            if(maxInMonth > 0) { if(c > maxInMonth * 0.25) lvl = "lvl-2"; if(c > maxInMonth * 0.50) lvl = "lvl-3"; if(c > maxInMonth * 0.75) lvl = "lvl-4"; }
            const el = document.createElement('div'); el.className = `cal-day ${lvl}`;
            el.innerText = d; 
            el.dataset.date = dateStr;
            if(currentFilter.type === 'day') {
                const curP = currentFilter.value.split('/').map(Number);
                if(curP[0]===calYear && curP[1]===(calMonth+1) && curP[2]===d) el.classList.add('active');
            }
            if (targetDate < minDateObj || targetDate > maxDateObj || c === 0) {
                el.classList.add('disabled');
            }
            grid.appendChild(el);
        }
        while(grid.children.length < 42) grid.innerHTML += `<div class="cal-day empty"></div>`;
    }

    function shiftCal(offset) { calMonth += offset; if(calMonth>11){calMonth=0;calYear++} if(calMonth<0){calMonth=11;calYear--} renderCalendarWidget(); }

    function renderRankingView() {
        const genSel = document.getElementById('genSelector');
        const currentGen = genSel.value; 
        const totals = {};
        allLogs.forEach(l => { 
            if(isDateInPeriod(l.date, currentFilter)) {
                const c = parseInt(l.count) || 0;
                totals[l.name] = (totals[l.name]||0) + c;
            }
        });
        const activeGens = new Set();
        allMembers.forEach(m => { if ((totals[m.name] || 0) > 0) activeGens.add(m.gen); });
        
        // â˜…ä¿®æ­£ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å†ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„
        const savedVal = genSel.value || "all";
        genSel.innerHTML = "";
        genSel.appendChild(new Option("å…¨ãƒ¡ãƒ³ãƒãƒ¼", "all"));
        Array.from(activeGens).sort().forEach(g => {
            const label = genKanji[g] || `${g}æœŸç”Ÿ`;
            genSel.appendChild(new Option(label, g));
        });
        const optionsArr = Array.from(genSel.options);
        if (optionsArr.some(o => o.value === savedVal)) genSel.value = savedVal; else genSel.value = "all";

        const gen = genSel.value;
        const targets = allMembers.filter(m => {
            if (gen !== 'all' && m.gen != gen) return false;
            return isActiveMemberInPeriod(m);
        });

        const ranking = targets.map(m => ({ name: m.name, count: totals[m.name] || 0, color: m.color || '#ccc' })).sort((a,b) => b.count - a.count);
        rankingList = ranking.map(r => r.name);

        const area = document.getElementById('rankingArea');
        if(!ranking.length) area.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        else {
            let html = '<table class="ranking-table"><tbody>'; 
            const max = ranking[0].count;
            let currentRank = 1;
            ranking.forEach((r, i) => {
                if (i > 0 && r.count < ranking[i - 1].count) currentRank = i + 1;
                const rc = currentRank <= 3 ? `rank-${currentRank}` : '';
                const w = (max > 0) ? (r.count / max) * 100 : 0;
                html += `<tr onclick="openModal('${r.name}')">
                    <td style="width:50px; text-align:center;"><span class="rank-num ${rc}">${currentRank}</span></td>
                    <td style="width:140px; font-weight:bold;">${r.name}</td>
                    <td><div class="bar-wrap"><div class="bar-bg"><div class="bar-fill" style="width:${w}%; background:${r.color}"></div></div><div class="bar-txt">${r.count.toLocaleString()}</div></div></td>
                </tr>`; 
            });
            area.innerHTML = html + '</tbody></table>';
        }
    }

    function renderMemberCatalog() {
        const genSelector = document.getElementById('genSelector2');
        const selectedGen = genSelector.value;
        catalogList = []; 
        const container = document.getElementById('memberGrid');
        container.innerHTML = "";
        let gensToShow = [];
        if (selectedGen === 'all') { gensToShow = [...new Set(allMembers.map(m => m.gen))].sort(); } else { gensToShow = [selectedGen]; }

        gensToShow.forEach(g => {
            const targets = allMembers.filter(m => m.gen == g);
            if (targets.length === 0) return;
            targets.forEach(m => catalogList.push(m.name));
            const section = document.createElement('div');
            section.className = "gen-section";
            const header = document.createElement('div');
            header.className = "gen-header";
            header.innerText = genKanji[g] || `${g}æœŸç”Ÿ`;
            section.appendChild(header);
            const grid = document.createElement('div');
            grid.className = "grid-container";
            grid.innerHTML = targets.map(m => {
                const tagLink = m.tag ? `<a href="https://x.com/search?q=${encodeURIComponent(m.tag)}" target="_blank" class="x-link" onclick="event.stopPropagation()">ğ•</a>` : '';
                return `
                <div class="m-card" style="--c:${m.color||'#ccc'}" onclick="openModal('${m.name}', 'all:all')">
                    <div class="m-icon">${m.name.charAt(0)}</div>
                    <div class="m-name"><span>${m.name}</span>${tagLink}</div>
                </div>`;
            }).join('');
            section.appendChild(grid);
            container.appendChild(section);
        });
    }

    function renderRecordPage() {
        const type = document.getElementById('recordTypeSelector').value;
        const area = document.getElementById('recordContentArea');
        area.innerHTML = ""; 

        let html = '<table class="ranking-table"><tbody>';
        let dataList = [];
        let maxVal = 0;

        // â˜…çµ±è¨ˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (ç¢ºå®Ÿã«å‹•ãverboseãªæ›¸ãæ–¹)
        const statsMap = {}; 
        const oneDay = 24 * 60 * 60 * 1000;
        
        // 1. åˆæœŸåŒ–
        allMembers.forEach(m => {
            let startDate = minDateObj;
            if (m.joinDate) startDate = new Date(m.joinDate);

            let endDate = maxDateObj;
            if (m.gradDate) {
                const gD = new Date(m.gradDate);
                if (gD < endDate) endDate = gD;
            }

            statsMap[m.name] = { 
                name: m.name, 
                color: m.color || '#ccc',
                total: 0, activeDays: 0, streakMax: 0, currentStreak: 0, 
                highVolumeDays: 0, perfectMonthCount: 0, top3Count: 0,
                streakStart: null, streakEnd: null, // â˜…è¿½åŠ ï¼šæœŸé–“è¨˜éŒ²ç”¨
                maxStreakStart: null, maxStreakEnd: null,
                startDate: startDate, endDate: endDate,
                hasJoinDate: !!m.joinDate, isGraduated: !!m.gradDate,
                logs: {}, firstLogDate: null
            };
        });

        // 2. ãƒ­ã‚°é›†è¨ˆ
        allLogs.forEach(l => {
            if (statsMap[l.name]) {
                const s = statsMap[l.name];
                const count = parseInt(l.count) || 0;
                // æ—¥ä»˜ã‚’æ¨™æº–åŒ–ã—ã¦ã‚­ãƒ¼ã«ã™ã‚‹
                const d = new Date(l.date);
                const stdDateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
                
                s.logs[stdDateStr] = count;
                s.total += count;
                if (count > 0) {
                    s.activeDays++;
                    if (!s.firstLogDate || d < s.firstLogDate) s.firstLogDate = d;
                    if (count >= 10) s.highVolumeDays++;
                }
            }
        });

        // 3. ãƒ«ãƒ¼ãƒ—è¨ˆç®— (æ—¥æ¬¡)
        const dateStrList = [];
        let dLoop = new Date(minDateObj);
        while (dLoop <= maxDateObj) {
            dateStrList.push(`${dLoop.getFullYear()}/${dLoop.getMonth()+1}/${dLoop.getDate()}`);
            dLoop.setDate(dLoop.getDate() + 1);
        }

        // Top3è¨ˆç®—
        dateStrList.forEach(dateStr => {
            const dObj = new Date(dateStr);
            const dailyRank = [];
            allMembers.forEach(m => {
                const gDate = m.gradDate ? new Date(m.gradDate) : null;
                if (gDate) gDate.setHours(23,59,59);
                if (gDate && dObj > gDate) return; 

                const count = statsMap[m.name].logs[dateStr] || 0;
                if (count > 0) dailyRank.push({ name: m.name, count: count });
            });
            dailyRank.sort((a,b) => b.count - a.count);
            if (dailyRank.length > 0) {
                const top3Values = [...new Set(dailyRank.map(r => r.count))].slice(0, 3);
                dailyRank.forEach(r => {
                    if (top3Values.includes(r.count)) statsMap[r.name].top3Count++;
                });
            }
        });

        // æœˆæ¬¡è¨ˆç®— (çš†å‹¤)
        let currY = minDateObj.getFullYear();
        let currM = minDateObj.getMonth();
        const endY = maxDateObj.getFullYear();
        const endM = maxDateObj.getMonth();
        
        while (currY < endY || (currY === endY && currM <= endM)) {
            const daysInMonth = new Date(currY, currM + 1, 0).getDate();
            const monthStart = new Date(currY, currM, 1);
            const monthEnd = new Date(currY, currM, daysInMonth);
            monthEnd.setHours(23,59,59);

            allMembers.forEach(m => {
                const s = statsMap[m.name];
                if (s.startDate > monthStart || s.endDate < monthEnd) return; // é€”ä¸­åŠ å…¥/å’æ¥­æœˆã¯é™¤å¤–

                let isPerfect = true;
                for (let d = 1; d <= daysInMonth; d++) {
                    const checkDate = `${currY}/${currM+1}/${d}`;
                    if (!s.logs[checkDate] || s.logs[checkDate] === 0) { isPerfect = false; break; }
                }
                if (isPerfect) s.perfectMonthCount++;
            });
            currM++;
            if (currM > 11) { currM = 0; currY++; }
        }

        // å€‹åˆ¥è¨ˆç®— (Duration, Streak)
        allMembers.forEach(m => {
            const s = statsMap[m.name];
            let realStart = s.startDate;
            if (!s.hasJoinDate && s.firstLogDate) realStart = s.firstLogDate;
            if (realStart < minDateObj) realStart = minDateObj;

            const diffTime = Math.abs(s.endDate - realStart);
            const durationDays = Math.ceil(diffTime / oneDay) + 1;
            s.duration = durationDays > 0 ? durationDays : 1; 

            let tempStreak = 0;
            let streakStart = null;
            
            const gDate = m.gradDate ? new Date(m.gradDate) : null;
            if (gDate) gDate.setHours(23,59,59);

            dateStrList.forEach(dateStr => {
                if (gDate && new Date(dateStr) > gDate) return;
                const count = s.logs[dateStr] || 0;
                
                if (count > 0) {
                    if (tempStreak === 0) streakStart = dateStr; // ã‚¹ãƒˆãƒªãƒ¼ã‚¯é–‹å§‹
                    tempStreak++;
                    if (tempStreak > s.streakMax) {
                        s.streakMax = tempStreak;
                        s.maxStreakStart = streakStart;
                        s.maxStreakEnd = dateStr;
                    }
                } else {
                    tempStreak = 0;
                    streakStart = null;
                }
            });
        });

        // === ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º ===
        let unit = "";
        let isDecimal = false;

        // ã‚¤ãƒ™ãƒ³ãƒˆç³» (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ããªã„ã‚‚ã®)
        if (type === 'wins') {
            const dailyWins = {}; const dates = new Set();
            allLogs.forEach(l => { if((parseInt(l.count)||0) > 0) dates.add(l.date); });
            Array.from(dates).forEach(date => {
                let maxInDay = 0; const recs = [];
                allLogs.forEach(l => { if(l.date === date) { const c=parseInt(l.count)||0; if(c>maxInDay) maxInDay=c; recs.push({name:l.name, count:c}); }});
                if(maxInDay>0) { recs.forEach(r => { if(r.count===maxInDay) dailyWins[r.name]=(dailyWins[r.name]||0)+1; }); }
            });
            dataList = Object.keys(dailyWins).map(n => ({ name: n, count: dailyWins[n], color: memberMap[n]?.color||'#ccc' })).sort((a,b)=>b.count-a.count);
            if(dataList.length) maxVal = dataList[0].count;
            unit = "å›";
            // æç”»ã¸ (å…±é€šåŒ–ã›ãšæ„šç›´ã«æ›¸ã)
            let rank = 1;
            dataList.forEach((r, i) => {
                if(i>0 && r.count<dataList[i-1].count) rank=i+1;
                const rc = rank<=3 ? `rank-${rank}` : '';
                const w = (r.count/maxVal)*100; // â˜…wå®šç¾©
                html += `<tr onclick="openModal('${r.name}', 'all:all')"><td style="width:40px;text-align:center"><span class="rank-num ${rc}">${rank}</span></td><td style="width:140px;font-weight:bold">${r.name}</td><td><div class="bar-wrap"><div class="bar-bg"><div class="bar-fill" style="width:${w}%;background:${r.color}"></div></div><div class="bar-txt">${r.count}${unit}</div></div></td></tr>`;
            });

        } else if (type === 'daily_max') {
            dataList = allLogs.map(l => ({ date: l.date, name: l.name, count: parseInt(l.count)||0, color: memberMap[l.name]?.color||'#ccc' })).filter(r => r.count>0).sort((a,b)=>b.count-a.count).slice(0, 30);
            if(dataList.length) maxVal = dataList[0].count;
            let rank = 1;
            dataList.forEach((r, i) => {
                if(i>0 && r.count<dataList[i-1].count) rank=i+1;
                const rc = rank<=3 ? `rank-${rank}` : '';
                const w = (r.count/maxVal)*100;
                html += `<tr onclick="openDailyRankingModal('${r.date}')"><td style="width:40px;text-align:center"><span class="rank-num ${rc}">${rank}</span></td><td style="width:140px"><div style="font-weight:bold">${r.name}</div><div style="font-size:10px;color:#888">${r.date}</div></td><td><div class="bar-wrap"><div class="bar-bg"><div class="bar-fill" style="width:${w}%;background:${r.color}"></div></div><div class="bar-txt">${r.count}</div></div></td></tr>`;
            });

        } else if (type === 'monthly_max') {
            const monthlyData = {};
            allLogs.forEach(l => {
                const ym = l.date.split('/').slice(0,2).join('/');
                const key = ym + '_' + l.name;
                monthlyData[key] = (monthlyData[key]||0) + (parseInt(l.count)||0);
            });
            dataList = Object.keys(monthlyData).map(k => {
                const [ym, name] = k.split('_');
                return { date: ym, name: name, count: monthlyData[k], color: memberMap[name]?.color||'#ccc' };
            }).sort((a,b)=>b.count-a.count).slice(0, 30);
            if(dataList.length) maxVal = dataList[0].count;
            let rank = 1;
            dataList.forEach((r, i) => {
                if(i>0 && r.count<dataList[i-1].count) rank=i+1;
                const rc = rank<=3 ? `rank-${rank}` : '';
                const w = (r.count/maxVal)*100;
                // â˜…ä¿®æ­£: ã‚¯ãƒªãƒƒã‚¯ã§æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¸
                html += `<tr onclick="openMonthlyRankingModal('${r.date}')"><td style="width:40px;text-align:center"><span class="rank-num ${rc}">${rank}</span></td><td style="width:140px"><div style="font-weight:bold">${r.name}</div><div style="font-size:10px;color:#888">${r.date.replace('/','å¹´')}æœˆ</div></td><td><div class="bar-wrap"><div class="bar-bg"><div class="bar-fill" style="width:${w}%;background:${r.color}"></div></div><div class="bar-txt">${r.count}</div></div></td></tr>`;
            });

        } else {
            // çµ±è¨ˆãƒãƒƒãƒ—ã‚’ä½¿ã†ç³»
            if (type === 'total') {
                dataList = Object.values(statsMap).sort((a,b) => b.total - a.total);
                maxVal = dataList[0].total; unit="";
            } else if (type === 'streak') {
                dataList = Object.values(statsMap).filter(s => s.streakMax > 0).sort((a,b) => b.streakMax - a.streakMax);
                maxVal = dataList[0].streakMax; unit="æ—¥";
            } else if (type === 'average') {
                dataList = Object.values(statsMap).map(s => { s.avg = s.duration>0?s.total/s.duration:0; return s; }).sort((a,b) => b.avg - a.avg);
                maxVal = dataList[0].avg; unit=""; isDecimal=true;
            } else if (type === 'active_rate') {
                dataList = Object.values(statsMap).map(s => { s.rate = s.duration>0?(s.activeDays/s.duration)*100:0; return s; }).sort((a,b) => b.rate - a.rate);
                maxVal = 100; unit="%"; isDecimal=true; // rateã¯æœ€å¤§100å›ºå®šã§ã‚‚OKã ãŒã€ã“ã“ã§ã¯ç›¸å¯¾ã§ãªã100%åŸºæº–
            } else if (type === 'high_volume') {
                dataList = Object.values(statsMap).sort((a,b) => b.highVolumeDays - a.highVolumeDays);
                maxVal = dataList[0].highVolumeDays; unit="å›";
            } else if (type === 'perfect_months') {
                dataList = Object.values(statsMap).filter(s => s.perfectMonthCount > 0).sort((a,b) => b.perfectMonthCount - a.perfectMonthCount);
                maxVal = dataList[0].perfectMonthCount; unit="ãƒ¶æœˆ";
            } else if (type === 'top3') {
                dataList = Object.values(statsMap).sort((a,b) => b.top3Count - a.top3Count);
                maxVal = dataList[0].top3Count; unit="å›";
            }

            // æç”»
            let rank = 1;
            dataList.forEach((r, i) => {
                let val = 0;
                if(type==='total') val=r.total;
                if(type==='streak') val=r.streakMax;
                if(type==='average') val=r.avg;
                if(type==='active_rate') val=r.rate;
                if(type==='high_volume') val=r.highVolumeDays;
                if(type==='perfect_months') val=r.perfectMonthCount;
                if(type==='top3') val=r.top3Count;

                if (i > 0) {
                    let prevVal = 0; // å‰ã®äººã®å€¤å–å¾—ï¼ˆç°¡æ˜“ï¼‰
                    if(type==='total') prevVal=dataList[i-1].total;
                    if(type==='streak') prevVal=dataList[i-1].streakMax;
                    if(type==='average') prevVal=dataList[i-1].avg;
                    if(type==='active_rate') prevVal=dataList[i-1].rate;
                    if(type==='high_volume') prevVal=dataList[i-1].highVolumeDays;
                    if(type==='perfect_months') prevVal=dataList[i-1].perfectMonthCount;
                    if(type==='top3') prevVal=dataList[i-1].top3Count;
                    
                    if (val < prevVal) rank = i + 1;
                }

                const rc = rank <= 3 ? `rank-${rank}` : '';
                const w = (maxVal > 0) ? (val / maxVal) * 100 : 0; // â˜…wå®šç¾©
                const valStr = isDecimal ? val.toFixed(type==='average'?2:1) : val.toLocaleString();
                
                // â˜…è¿½åŠ : ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã®æœŸé–“è¡¨ç¤º
                let subHtml = "";
                if(type === 'streak' && r.maxStreakStart && r.maxStreakEnd) {
                    subHtml = `<div style="font-size:10px;color:#888;">${r.maxStreakStart} - ${r.maxStreakEnd}</div>`;
                }

                html += `<tr onclick="openModal('${r.name}', 'all:all')">
                    <td style="width:40px;text-align:center"><span class="rank-num ${rc}">${rank}</span></td>
                    <td style="width:140px;font-weight:bold">${r.name}${subHtml}</td>
                    <td><div class="bar-wrap"><div class="bar-bg"><div class="bar-fill" style="width:${w}%;background:${r.color}"></div></div><div class="bar-txt" style="width:60px">${valStr}${unit}</div></div></td>
                </tr>`;
            });
        }

        html += '</tbody></table>';
        area.innerHTML = html;
    }

    // â˜…è¿½åŠ : æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openMonthlyRankingModal(ym) {
        document.body.classList.add('no-scroll');
        const [year, month] = ym.split('/');
        
        // ãã®æœˆã®é›†è¨ˆ
        const memberTotals = {};
        allLogs.forEach(l => {
            const p = l.date.split('/');
            if (p[0] == year && p[1] == month) {
                const count = parseInt(l.count) || 0;
                memberTotals[l.name] = (memberTotals[l.name] || 0) + count;
            }
        });

        // é…åˆ—åŒ– & ã‚½ãƒ¼ãƒˆ
        const ranking = Object.keys(memberTotals).map(name => ({
            name: name,
            count: memberTotals[name],
            color: memberMap[name]?.color || '#ccc'
        })).sort((a, b) => b.count - a.count);

        let html = '<table class="ranking-table"><tbody>';
        const max = ranking.length > 0 ? ranking[0].count : 0;
        let rank = 1;

        ranking.forEach((r, i) => {
            if (i > 0 && r.count < ranking[i - 1].count) rank = i + 1;
            const rc = rank <= 3 ? `rank-${rank}` : '';
            const w = (max > 0) ? (r.count / max) * 100 : 0;
            
            html += `<tr onclick="openModal('${r.name}', 'month:${ym}')">
                <td style="width:50px; text-align:center;"><span class="rank-num ${rc}">${rank}</span></td>
                <td style="width:140px; font-weight:bold;">${r.name}</td>
                <td><div class="bar-wrap"><div class="bar-bg"><div class="bar-fill" style="width:${w}%; background:${r.color}"></div></div><div class="bar-txt">${r.count}</div></div></td>
            </tr>`;
        });
        html += '</tbody></table>';

        document.getElementById('dailyModalTitle').innerText = `${ym.replace('/','å¹´')}æœˆã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°`;
        document.getElementById('dailyRankingArea').innerHTML = html;
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('dailyModal').style.display = 'block';
    }

    function openDailyRankingModal(dateStr) {
        document.body.classList.add('no-scroll');
        const ranking = allLogs
            .filter(l => l.date === dateStr)
            .map(l => ({ name: l.name, count: parseInt(l.count) || 0, color: memberMap[l.name]?.color || '#ccc' }))
            .filter(r => r.count > 0)
            .sort((a, b) => b.count - a.count);

        let html = '<table class="ranking-table"><tbody>';
        const max = ranking.length > 0 ? ranking[0].count : 0;
        let rank = 1;
        ranking.forEach((r, i) => {
            if (i > 0 && r.count < ranking[i - 1].count) rank = i + 1;
            const rc = rank <= 3 ? `rank-${rank}` : '';
            const w = (r.count / max) * 100;
            html += `<tr onclick="openModal('${r.name}', 'month:${dateStr.split('/').slice(0,2).join('/')}')"><td style="width:50px; text-align:center;"><span class="rank-num ${rc}">${rank}</span></td><td style="width:140px; font-weight:bold;">${r.name}</td><td><div class="bar-wrap"><div class="bar-bg"><div class="bar-fill" style="width:${w}%; background:${r.color}"></div></div><div class="bar-txt">${r.count}</div></div></td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('dailyModalTitle').innerText = `${dateStr} ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°`;
        document.getElementById('dailyRankingArea').innerHTML = html;
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('dailyModal').style.display = 'block';
    }

    function openModal(name, preferredPeriod = null) {
        document.body.classList.add('no-scroll');
        currentModalMember = name;
        document.getElementById('dailyModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
        document.getElementById('modalName').innerText = name;
        const stats = { months: new Map(), years: new Set(), h1: new Set(), h2: new Set() };
        allLogs.forEach(l => { if(l.name === name) { const c = parseInt(l.count)||0; if(c>0){ const p=l.date.split('/').map(Number); stats.months.set(p[0]+'/'+p[1], (stats.months.get(p[0]+'/'+p[1])||0)+c); stats.years.add(p[0]); if(p[1]<=6) stats.h1.add(p[0]); else stats.h2.add(p[0]); } } });
        
        const mSel = document.getElementById('modalPeriodSelector'); mSel.innerHTML = "";
        mSel.appendChild(new Option('å…¨æœŸé–“', 'all:all'));
        Array.from(stats.months.keys()).sort((a,b)=>new Date(b+'/1')-new Date(a+'/1')).forEach(ym=>mSel.appendChild(new Option(ym.replace('/','å¹´')+'æœˆ', `month:${ym}`)));
        Array.from(stats.years).sort().reverse().forEach(y=>{ mSel.appendChild(new Option(`--- ${y}å¹´ è¨˜éŒ² ---`, `disabled`)).disabled=true; mSel.appendChild(new Option(`${y}å¹´ å¹´é–“`, `year:${y}`)); if(stats.h1.has(y)) mSel.appendChild(new Option(`${y}å¹´ ä¸ŠåŠæœŸ`, `h1:${y}`)); if(stats.h2.has(y)) mSel.appendChild(new Option(`${y}å¹´ ä¸‹åŠæœŸ`, `h2:${y}`)); });

        let def = "";
        if (preferredPeriod) {
            def = preferredPeriod;
        } else {
            if (currentFilter.type === 'day') {
                const p = currentFilter.value.split('/').map(Number);
                def = `month:${p[0]}/${p[1]}`;
            } else if (currentFilter.type === 'month') {
                const p = currentFilter.value.split('/').map(Number);
                def = `month:${p[0]}/${p[1]}`;
            } else if (currentFilter.type === 'all') {
                def = 'all:all';
            } else {
                def = `${currentFilter.type}:${currentFilter.value}`;
            }
        }
        const optionsArr = Array.from(mSel.options);
        if (optionsArr.some(o => o.value === def)) mSel.value = def; else mSel.selectedIndex = 0;
        updateModalContent();
    }

    function updateModalContent() {
        const name = currentModalMember, [type, value] = document.getElementById('modalPeriodSelector').value.split(':');
        const filter = { type, value }, member = memberMap[name];
        let labels = [], bars = [], lines = [], sum = 0, max = 0;
        let rawTargets = [];

        if(type === 'month') {
            const [yStr, mStr] = value.split('/');
            const year = parseInt(yStr);
            const month = parseInt(mStr);
            const daysInMonth = new Date(year, month, 0).getDate();
            const logMap = {};
            
            allLogs.forEach(l => {
                if(l.name === name && isDateInPeriod(l.date, filter)) {
                    const d = parseInt(l.date.split('/')[2]);
                    logMap[d] = parseInt(l.count) || 0;
                }
            });

            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month - 1, d);
                if (dateObj < minDateObj) continue; 
                if (dateObj > maxDateObj) break; 

                const count = logMap[d] || 0;
                sum += count;
                if(count > max) max = count;
                
                labels.push(d + 'æ—¥');
                bars.push(count);
                lines.push(sum);
                rawTargets.push(`${year}/${month}/${d}`);
            }
        } else {
            const mSum = new Map(); allLogs.forEach(l => { 
                if(l.name === name && isDateInPeriod(l.date, filter)) { const p = l.date.split('/').map(Number); const ym = p[0]+'/'+p[1]; mSum.set(ym, (mSum.get(ym)||0)+(parseInt(l.count)||0)); } 
            });
            Array.from(mSum.keys()).sort((a,b)=>new Date(a+'/1')-new Date(b+'/1')).forEach(ym => { 
                const c=mSum.get(ym); sum+=c; if(c>max) max=c; labels.push(ym); bars.push(c); lines.push(sum); rawTargets.push(ym); 
            });
        }
        
        document.getElementById('mTotal').innerText = sum.toLocaleString(); document.getElementById('mMax').innerText = max.toLocaleString();
        document.getElementById('mAvg').innerText = bars.length ? (sum / bars.length).toFixed(1) : 0.0;
        if(chartInstance) chartInstance.destroy();
        
        const accentColor = '#FF9F43'; 
        
        chartInstance = new Chart(document.getElementById('personalChart').getContext('2d'), {
            type: 'bar', data: { labels, datasets: [
                { type: 'line', label: 'ç´¯è¨ˆ', data: lines, borderColor: accentColor, backgroundColor: accentColor, pointBackgroundColor: accentColor, pointRadius: 4, borderWidth: 3, yAxisID: 'y1', tension: 0.1, order: 0 },
                { type: 'bar', label: (type==='month'?'æ—¥æ¬¡':'æœˆæ¬¡'), data: bars, backgroundColor: member.color + '99', borderColor: member.color, borderWidth: 1, yAxisID: 'y', order: 1 }
            ]},
            options: { 
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                scales: { 
                    x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45, font: { size: 10 } } }, 
                    y: { 
                        position: 'left', 
                        beginAtZero: true, 
                        ticks: { precision: 0, maxTicksLimit: 6 } 
                    }, 
                    y1: { 
                        position: 'right', 
                        beginAtZero: true, 
                        grid: { drawOnChartArea: false }, 
                        ticks: { precision: 0, maxTicksLimit: 6 } 
                    } 
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const targetValue = rawTargets[index];
                        if (type === 'month') { closeModal(); selectPeriod('day', targetValue); } 
                        else {
                            const mSel = document.getElementById('modalPeriodSelector');
                            const newVal = `month:${targetValue}`;
                            const exists = Array.from(mSel.options).some(o => o.value === newVal);
                            if (exists) { mSel.value = newVal; updateModalContent(); }
                        }
                    }
                },
                onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; },
                plugins: { legend: { labels: { usePointStyle: true, boxWidth: 10 } } }
            }
        });
    }

    function closeModal() { 
        document.body.classList.remove('no-scroll');
        document.getElementById('modalOverlay').style.display = 'none'; 
        document.getElementById('modal').style.display = 'none'; 
        document.getElementById('dailyModal').style.display = 'none'; 
    }
</script>
</body>
</html>